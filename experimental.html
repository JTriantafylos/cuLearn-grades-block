<p style = "display: none" id = "seen">https://culearn.carleton.ca/moodle/pluginfile.php/2987397/block_html/content/seen.json</p>

<div id="GradesTable"></div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>
  function getUrlParams(url) {
    var params = {};
    url.substring(1).replace(/[?&]+([^=&]+)=([^&]*)/gi,
            function (str, key, value) {
                 params[key] = value;
            });
    return params;
  }
  function fetchGrades(){
    var links = $(".courses:first").children();
    for (var x = 0; x < links.length; x++){
      links[x] = getUrlParams($(links[x]).find("a")[0].href);
      links[x] = $.ajax({
      url:"https://culearn.carleton.ca/moodle/grade/report/user/index.php?id="+links[x]['id'],
      success: function(data){
          var fullTable = $(data).find("tbody")[0].innerHTML;
          var remove = $(fullTable).find(".column-feedback");
          for (var x = 0; x < remove.length; x++){
            fullTable = fullTable.replace(remove[x].innerHTML, "");
          }
          document.getElementById("GradesTable").innerHTML +=  "<table>"+ fullTable + "</table><div style = \"width:100%; border-bottom: 1px solid black;\"></div>";
          }
      });
    }
  }

  function saveData(set){
    set.newStuff = "0";
    data = new FormData();
    data.append('file', new Blob([set],{type:'application/json'}));

    $.ajax({
      url:"https://culearn.carleton.ca/moodle/repository/repository_ajax.php?action=overwrite",
      data: data,
      type: 'POST',
      processData: false,
      mimeType: 'multipart/form-data',
      contentType: 'multipart/form-data',
      success: function(data){
        console.log(data);
      },
      error: function(e){
        console.log("something went wrong");
        console.log(e);
      }

    });
  }
  var url = $('#seen')[0].innerHTML;
  var set = {};
  console.log(url);
  $.ajax({
    url: url,
    dataType: 'json',
    success: function(data){
      saveData(data);
    }, 
  });

</script>